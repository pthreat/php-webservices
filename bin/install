#!/bin/bash

export dir=$(dirname $0);

cd $dir/..

echo "Installing composer dependencies"

./bin/composer install 

./bin/propel-generate-sql
./bin/propel-create-config
./bin/propel-create-models

export name="John";
export lastname="Doe";
export email="webservices@gmail.com";
export password="admin";

export encPassword=$(php -r "echo password_hash('$password', PASSWORD_DEFAULT);");

export dbPass=$(php -r "require 'config/database/dbConstants.php'; echo DB_PASSWORD;");
export dbUser=$(php -r "require 'config/database/dbConstants.php'; echo DB_USERNAME;");
export dbName=$(php -r "require 'config/database/dbConstants.php'; echo DB_NAME;");

export sql="
	DROP DATABASE IF EXISTS $dbName;
	CREATE DATABASE $dbName;
	GRANT ALL PRIVILEGES ON $dbName.* TO $dbUser@localhost IDENTIFIED BY '$dbPass';
";

echo -e "\n\nWARNING: If you have run the installer before this will destroy your current database, press  CTRL+C to abort\n\n"

read -p 'root user database password (press enter for no password):' sqlPass

echo "Creating database and importing generated SQL file"

mysql -uroot -p"$sqlPass" <<< "$sql";
mysql -uroot -p"$sqlPass" -D$dbName < ./sql/default.sql;

echo "Adding default admin user: User: $email | Pass: $password";

mysql -uroot -p"$sqlPass" -D$dbName <<< "
INSERT INTO user 
SET name='$name',
lastname='$lastname',
email='$email',
password='$encPassword',
isAdmin=1;
";

echo "Adding models folder generated by propel to the composer autoloader"

export composerJSON=$(php -r '$conf=json_decode(file_get_contents("composer.json"), true); $conf["autoload"]["classmap"] = ["model/webservices/orm"]; echo json_encode($conf, \JSON_PRETTY_PRINT);');

echo "$composerJSON" > "composer.json";

./bin/composer dump-autoload

[ ! -d "logs" ] && echo "Creating logs directory" && mkdir logs

echo "All done!"
